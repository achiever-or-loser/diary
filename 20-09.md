# Hystrix

资源隔离主要指对线程的隔离。Hystrix提供了两种线程隔离方式：线程池和信号量。

信号量隔离控制并发请求量，防止线程大面积阻塞



![data trans](https://img-blog.csdn.net/20181025133657804?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1NDg0MTQ3/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# Sentinel

https://github.com/alibaba/Sentinel/wiki

通过并发线程数进行限制，没有线程切换的损耗

通过响应时间对资源降级

滑动窗口

SphU.entry(resource)





# Feigin

伪HTTP；http请求调用的轻量级框架

[官网文档](https://cloud.spring.io/spring-cloud-openfeign/reference/html/#spring-cloud-feign)

[设计流程](https://img-blog.csdn.net/20180925130831141?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAzNDkxNjk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

ReflectiveFeign#newInstance解析；Contract 协议；基于RequestBean动态生成Request；用Encoder 将Bean转换成 Http报文正文；拦截器负责对请求和返回进行处理；基于重试器发送HTTP请求；发送Http请求

每次发送请求的时候，都会创建新的HttpURLConnection 链接；可以通过拓展该接口，使用Apache HttpClient 或者OkHttp3等基于连接池的高性能Http客户端

采用池化连接后效率——测试



https://blog.csdn.net/luanlouis/article/details/82821294





![设计流程](https://img-blog.csdn.net/20180925130831141?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAzNDkxNjk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)



对比restTemplate：RestTemplate对象在底层通过ClientHttpRequest.execute()

feign同样可以使用IP的形式发送HTTP请求





# Java

java [-options] class [args...]

java [-options] -jar jarfile [args...]

optioins

-server 选择 "server" VM，VM 是 server.

 -D<名称>=<值> 设置系统属性

eg：

java -Xms64m -Xmx128m  -DprocessType=1  -jar xxx.jar --spring,config.location=xxx --spring.profiles.active=dev --server.port=8080 processType2=2

System.getProperty("processType")



 @VisibleForTesting 将私有的方法改为protected，仅在测试中生效



java -jar -DJAVA_LOCALIP=127.0.0.1 -DJAVA_CONSULACLTOKEN=bdd19f97-4fe8-6f52-aad6-af7b33c2d3e3

mvn package -DJAVA_LOCALIP=127.0.0.1 -DJAVA_CONSULACLTOKEN=bdd19f97-4fe8-6f52-aad6-af7b33c2d3e3





# Spring



![springBoot 启动结构图](https://www.processon.com/view/link/59812124e4b0de2518b32b6e)

[springBoot 启动结构图](https://www.processon.com/view/link/59812124e4b0de2518b32b6e)

SpringApplication初始化模块：基本的环境变量、资源、构造器、监听器

应用启动方案：监听模块、加载配置环境模块、上下文环境模块

自动化配置：自动配置核心





~~~
# SSL
server.ssl.enabled=true
server.ssl.key-alias=tomcat
server.ssl.key-store=classpath:my.keystore
server.ssl.key-password=123qwe
server.ssl.key-store-type=JKS
spring.application.name=demo

# http响应压缩
server.compression.enabled=true
server.compression.min-response-size=1
server.compression.mime-types=text/html
~~~









# consul

服务删除

[paas-portal-sit-9003](https://blog.csdn.net/v1/agent/service/deregister/paas-portal-sit-9003) （服务名称id）

curl [http://server_ip:8500/v1/agent/service/deregister/paas-portal-sit-9003](https://blog.csdn.net/v1/agent/service/deregister/paas-portal-sit-9003) -X PUT

节点删除

[4b36b27317a0](https://blog.csdn.net/v1/agent/force-leave/4b36b27317a0)（节点ID）

[http://server_ip:8500/v1/agent/force-leave/4b36b27317a0](https://blog.csdn.net/v1/agent/force-leave/4b36b27317a0)





server-client模式：减轻server是压力；server挂掉，节点下的服务全部无效



## acl

~~~
{
    "datacenter":"tencent-datacenter",
    "data_dir":"/usr/local/consul-1.6.2/data",
    "log_file":"/usr/local/consul-1.6.2/log/",
    "log_level":"INFO",
    "bind_addr":"127.0.0.10",
    "client_addr":"127.0.0.1",
    "node_name":"tencent-node",
    "ui":true,
    "bootstrap_expect":1,
    "server":true,
    "acl":{
        "enabled":true,
        "default_policy":"deny",
        "enable_token_persistence":true,
        "enable_key_list_policy":true
    }
}
~~~

启动Consul：`./consul agent -config-file=config-acl.json`

初始化Consul ACL consul acl bootstrap

read、write、deny、list

服务策略

~~~
ervice_prefix "" {
  policy = "write"
}
~~~

kv策略

~~~
key_prefix "" {
 policy = "list"
}
key_prefix "" {
 policy = "write"
}
key_prefix "config/" {
 policy = "read"
}
~~~





### 集群

单台启动多个服务注意端口号

~~~
"start_join":[
        "10.211.55.25",
        "10.211.55.26"
    ],
    "retry_join":[
        "10.211.55.25",
        "10.211.55.26"
    ],
~~~



f6740892-6945-5a94-33b9-4b0ef4975db4

bdd19f97-4fe8-6f52-aad6-af7b33c2d3e3











# ribbon

![image-20200903153045555](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200903153045555.png)



ConsulServerList#getServers中ConsulClient去请求consul获取健康的服务列表

ConfigurationBasedServerList#getUpdatedListOfServers通过clientConfig获得ListOfServers

ServerList<T> serverListImpl

DynamicServerListLoadBalancer#updateListOfServers根据上下文具体的ServerList更新serverList

initWithNiwsConfig根据IClientConfig(DefaultClientConfigImpl)配置filter，serverlist，

重写DynamicServerListLoadBalancer#updateListOfServers？？consul中没有service读取配置路由

ConsulServerList#getServers？

拦截？

IClientConfig(DefaultClientConfigImpl)根据clientName获得所有的配置信息





```
NFLoadBalancerClassName`: 配置`ILoadBalancer的实现类
NFLoadBalancerRuleClassName: 配置should implement IRule的实现类
NIWSServerListClassName: 配置should implement ServerList的实现类
```



服务注册中心中的服务名不能带下划线

Invalid host: lb://de_mo

RouteToRequestUrlFilter中包含了正则的检查匹配

```java
if ("lb".equalsIgnoreCase(routeUri.getScheme()) && routeUri.getHost() == null) {
    throw new IllegalStateException("Invalid host: " + routeUri.toString());
}
```

consul在注册服务时会对服务的名字进行处理

ConsulAutoRegistration#registration

normalizeForDns 字符串不能为空,首字符必须为字母,尾字符必须为字母或数字,所有非字母数字的字符统一转换成'-'连接符,同时多个连续连接符转换成一个'-'.



# mongodb

```
docker run -itd --name mongo -p 27017:27017 mongo --auth
$ docker exec -it mongo mongo admin
# 创建一个名为 admin，密码为 123456 的用户。
>  db.createUser({ user:'admin',pwd:'admin',roles:[ { role:'userAdminAnyDatabase', db: 'admin'}]});
db.createUser({ user:'csc',pwd:'csc',roles:[ { role:'userAdminAnyDatabase'}]})
# 尝试使用上面创建的用户信息进行连接。
> db.auth('admin', '123456')
```



# Linux 

COW 写时复制

在Linux程序中，fork（）会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用。

只有进程空间的各段内同要发生变化时，才会经父进程中的内容复制一份给子进程。

在fork之后exec之前两个进程用的是相同的物理空间（内存区），子进程的代码段、数据段、堆栈都是指向父进程的物理空间，也就是说，两者的虚拟空间不同，但其对应的物理空间是同一个。当父子进程中有更改相应段的行为发生时，再为子进程相应的段分配物理空间，如果不是因为exec，内核会给子进程的数据段、堆栈段分配相应的物理空间（至此两者有各自的进程空间，互不影响），而代码段继续共享父进程的物理空间（两者的代码完全相同）。而如果是因为exec，由于两者执行的代码不同，子进程的代码段也会分配单独的物理空间。

fork之后内核会将子进程放在队列的前面

vfork子进程共享父进程的虚拟空间、物理空间

C++中string的处理类似COW

select 、 poll 、 epoll

io多路中多路单线程通过记录跟踪每个sock（io流）的状态同时管理多个io流。提高服务器的吞吐量

|            |                       select                       |                       poll                       |                            epoll                             |
| :--------- | :------------------------------------------------: | :----------------------------------------------: | :----------------------------------------------------------: |
| 操作方式   |                        遍历                        |                       遍历                       |                             回调                             |
| 底层实现   |                        数组                        |                       链表                       |                            红黑树                            |
| IO效率     |      每次调用都进行线性遍历，时间复杂度为O(n)      |     每次调用都进行线性遍历，时间复杂度为O(n)     | 事件通知方式，每当fd就绪，系统注册的回调函数就会被调用，将就绪fd放到readyList里面，时间复杂度O(1) |
| 最大连接数 |              1024（x86）或2048（x64）              |                      无上限                      |                            无上限                            |
| fd拷贝     | 每次调用select，都需要把fd集合从用户态拷贝到内核态 | 每次调用poll，都需要把fd集合从用户态拷贝到内核态 |  调用epoll_ctl时拷贝进内核并保存，之后每次epoll_wait不拷贝   |

kill -9 杀不掉的进程

kill -9 发送SIGKILL信号给进程，将其终止，但对于以下两种情况不适用

1.该进程是僵尸进程（STAT z），此时进程已经释放所有的资源，但是没有被父进程释放。僵尸进程要等到父进程结束，或者重启系统才可以被释放。

2.进程处于“核心态”，并且在等待不可获得的资源，处于“核心态 ”的资源默认忽略所有信号。只能重启系统。

读写磁盘时，read、write带有缓冲机制





# other

[分布式任务调度平台](https://github.com/xuxueli/xxl-job)











# Todo



security 

actuator   [官方文档](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/production-ready-features.html#production-ready)

[webflux ](https://docs.spring.io/spring/docs/5.2.8.RELEASE/spring-framework-reference/web-reactive.html#webflux)

rxJava

jmx

博客园目录

shell







# End

main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port(s): 9528

NettyWebServer  中getport返回为int类型的一个值

TomcatWebServer和JettyWebServer返回是用StringBuilder构建的String



```
<resources>
    <resource>
        <directory>src/main/resources</directory>
        <excludes>
            <exclude>**/*.jks</exclude>
        </excludes>
        <filtering>true</filtering>
    </resource>
    <resource>
        <directory>src/main/resources</directory>
        <filtering>false</filtering>
        <includes>
            <include>**/*.jks</include>
        </includes>
    </resource>
</resources>
```













AccessorID:       f6740892-6945-5a94-33b9-4b0ef4975db4
SecretID:         bdd19f97-4fe8-6f52-aad6-af7b33c2d3e3
Description:      Bootstrap Token (Global Management)
Local:            false
Create Time:      2020-09-15 14:59:48.5448592 +0800 CST
Policies:
   00000000-0000-0000-0000-000000000001 - global-management

# Question

kv 403

创建一个token，分配了policy，如service_prefix....用这个token登录ui，在Services中可以看到权限内的service！同理node也是一样，但是针对key/values不行，会直接跳转到ACL登录页面

这时候并不是acl没有权限，需要在浏览器中直接输入http://ip:8500/ui/dc1/kv/foo/，dc1是datacenter的名字，foo为policy赋予的kv前缀，这样就可以在ui中修改key/values了





Access to XMLHttpRequest at 'http://61.152.230.66/tradeApi/api/fund/market/tty7' from origin 'null' has been blocked by CORS policy: The 'Access-Control-Allow-Origin' header contains multiple values 'null, *', but only one is allowed



Access to XMLHttpRequest at 'http://localhost:9528/gateway/get' from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.

from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.



http://localhost:9528/gateway/post/1

http://61.152.230.66/tradeApi/api/fund/market/tty7

http://61.152.230.66/operateManager/api/validate/getimagecode?account=duqu